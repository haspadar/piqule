name: Prettier

on:
  workflow_call:
    inputs:
      node-version:
        type: string
        required: false
        default: "24"
      config:
        type: string
        required: false
        default: .piqule/prettier/.prettierrc.yml
      ignore-path:
        type: string
        required: false
        default: .piqule/prettier/.prettierignore
      prettier-version:
        type: string
        required: false
        default: "3.7.4"

jobs:
  prettier:
    name: Prettier
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------------------
      # Checkout repository
      # ------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2

      # ------------------------------------------------------------
      # Check Prettier config existence
      # ------------------------------------------------------------
      - name: Check config exists
        id: check
        env:
          PRETTIER_CONFIG: ${{ inputs.config }}
        run: |
          if [[ -f "$PRETTIER_CONFIG" ]]; then
            echo "run=true" >> "$GITHUB_OUTPUT"
          else
            echo "run=false" >> "$GITHUB_OUTPUT"
          fi

      # ------------------------------------------------------------
      # Skip Prettier when config is missing
      # ------------------------------------------------------------
      - name: Skip — no config found
        if: steps.check.outputs.run == 'false'
        env:
          PRETTIER_CONFIG: ${{ inputs.config }}
        run: echo "Skipping Prettier — no config found at $PRETTIER_CONFIG"

      # ------------------------------------------------------------
      # Setup Node.js
      # ------------------------------------------------------------
      - name: Setup Node.js
        if: steps.check.outputs.run == 'true'
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: ${{ inputs.node-version }}

      # ------------------------------------------------------------
      # Install Prettier
      # ------------------------------------------------------------
      - name: Install Prettier
        if: steps.check.outputs.run == 'true'
        run: npm install -g prettier@${{ inputs.prettier-version }}

      # ------------------------------------------------------------
      # Run Prettier (formatting gate)
      # ------------------------------------------------------------
      - name: Run Prettier
        if: steps.check.outputs.run == 'true'
        env:
          PRETTIER_CONFIG: ${{ inputs.config }}
          PRETTIER_IGNORE: ${{ inputs.ignore-path }}
        run: |
          echo "Using config: $PRETTIER_CONFIG"
          echo "Using ignore file: $PRETTIER_IGNORE"
          prettier --check . \
            --config "$PRETTIER_CONFIG" \
            --ignore-path "$PRETTIER_IGNORE"
